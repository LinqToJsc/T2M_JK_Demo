<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" style="background-color: #fff">
<!-- Head -->
<head>
    <meta charset="utf-8" />
    <title>金科大运营系统</title>
    <!-- 已完成项目列表 -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <style type="text/css">
        .box-header {
            background-color: #d7d8da;
        }

        .box-title span {
            font-size: 18px;
            color: #333;
        }

        .proj-info {
            font-size: 14px;
            color: #333;
        }

        .task-name-box {
            padding-top: 50px;
            padding-bottom: 0;
            font-size: 18px;
            color: #333;
            background: #fff;
            padding-left: 10px;
            margin-right: 5px !important;
            border-radius: 3px;
        }

        .achieve-box {
            font-size: 14px;
            color: #333;
            padding: 5px;
        }


        .direct-chat-messages {
            height: auto !important;
            background: #fff;
        }

        #CMY_expShare .row {
            margin: 0;
        }
        /* 自定义com样式 */
        .pddingClass {
            padding: 5px 0;
        }

        .pdds {
            padding: 5px 0px 0px 0px;
        }

        .boxId {
            border: 1px solid #D9D9F3;
            height: 390px;
            position: absolute;
            overflow: auto;
            margin-left: 15px;
        }

        .imgClass {
            height: 50px;
            width: 50px;
        }

        .imgClassL {
            height: 15px;
            width: 15px;
        }

        .ex-max {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
    </style>
    <style type="text/css">
        .t-user-box-alert {
            width: 320px !important;
            background-color: #ffffff !important;
            border: 1px solid #ddd !important;
            border-top: 3px solid #0cc1fb !important;
        }

        .t-user-box-alert-top {
            padding-left: 20px !important;
            background-color: #f5f5f5 !important;
            /* height: 42px !important; */
            line-height: 40px !important;
            color: #999999 !important;
        }

            .t-user-box-alert-top .btn {
                padding-top: 0px !important;
                padding-bottom: 0px !important;
                background-color: #fff !important;
                font-size: 16px !important;
                padding-right: 7px !important;
            }

        .t-user-box-alert-cox {
            padding: 0px 20px !important;
            background-color: #ffffff !important;
            height: 160px !important;
        }

        .t-userm-mes {
            height: 88px !important;
        }

            .t-userm-mes .t-u-img {
                float: left !important;
                width: 73px !important;
                height: 88px !important;
                padding: 15px 15px 15px 0 !important;
            }

                .t-userm-mes .t-u-img img {
                    height: 58px !important;
                    width: 58px !important;
                }

            .t-userm-mes .t-u-txt {
                padding: 25px 0 0 0 !important;
            }

                .t-userm-mes .t-u-txt .t-u-t {
                    font-size: 16px !important;
                    color: #666666 !important;
                }

                .t-userm-mes .t-u-txt .t-u-p {
                    font-size: 14px !important;
                    color: #999999 !important;
                }

        .t-user-details .t-user-opp {
            width: 100% !important;
            float: left !important;
            padding-bottom: 10px !important;
            color: #666666 !important;
            font-size: 14px !important;
            margin-top: 0px !important;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            padding-right: 15px;
        }

            .t-user-details .t-user-opp > span:first-child {
                color: #999999 !important;
                padding-right: 5px !important;
            }

        .ProjectManagerName {
            margin-top: 5px !important;
            display: inline-block !important;
            font-size: 14px !important;
            color: #3c8dbc !important;
        }

        .navdiv-left {
            float: left !important;
            margin-top: 20px !important;
        }

        .completedRate-box {
            padding-right: 0 !important;
            float: left !important;
            width: 50px !important;
            height: 50px !important;
            margin-left: 10px !important;
            margin-right: 10px !important;
            background-color: #3c8dbc !important;
            text-align: center !important;
            color: #fff !important;
            line-height: 50px !important;
            border-radius: 5px !important;
        }

        .projectNamedbox {
            white-space: nowrap !important;
        }
    </style>

    <%@include file="../../common/admin_css.jsp"%>
    <link rel="stylesheet" href="${contextPath}/static/style/project/ppm/CompleteProjectInfo.css?version=2.1.1530843110000">
    <link rel="stylesheet" href="${contextPath}/static/style/project/ppm/projectInfo/rightAlertBox.css?version=2.1.1530843110000">
    <style type="text/css">
        /* 反馈的图标 */
        .new_notice_feddbackMessage {
            position: fixed;
            bottom: 95px;
            right: 10px;
            background-image: url("${contextPath}/static/images/notice/new.png");
            background-position: 0px -142px;
            width: 68px;
            height: 62px;
            z-index: 20;
            cursor: pointer;
        }

        #feddbackMessage_box {
            position: fixed;
            z-index: 30;
            width: 520px;
            bottom: 50px;
            right: 25px;
            float: left;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding-bottom: 15px;
            display: none;
        }

            #feddbackMessage_box .headtit {
                background-color: #3c8dbc;
                padding: 5px 10px;
                border-radius: 3px;
                margin-bottom: 25px;
                color: #fff;
                font-size: 16px;
            }

        .messageLBox_feddback {
            padding: 0px 15px;
        }

            .messageLBox_feddback #messagefeddback {
                padding-top: 5px;
            }

        #feddbackMessageTxt {
            padding-top: 5px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }

        #feddbackMessage_close {
            cursor: pointer;
        }

        /*#at_Message_box*/
        #at_Message_box {
            width: 550px;
            height: 500px;
            z-index: 45;
            position: fixed;
            top: 75px;
            left: 0px;
            right: 0px;
            border-radius: 5px;
            border: 1px solid #ddd;
            background-color: #fff;
            margin-left: auto;
            margin-right: auto;
            display: none;
        }

            #at_Message_box .headtit {
                background-color: #3c8dbc;
                padding: 8px 10px;
                border-radius: 3px 3px 0 0;
                margin-bottom: 10px;
                color: #fff;
                font-size: 16px;
            }

        #feddbackMessageTxt {
            cursor: pointer;
        }

        #at_Message_box .tab_s {
            padding-left: 55px;
        }

            #at_Message_box .tab_s > span {
                display: inline-block;
                margin-right: 25px;
                cursor: pointer;
            }

                #at_Message_box .tab_s > span.active {
                    color: #44b5d9;
                    font-weight: 600;
                }

        #at_Message_box .con_tab {
            width: 100%;
            padding: 15px;
        }

        #at_Message_box_close {
            cursor: pointer;
        }

        #at_Message_box .con_tab > div {
            border: 1px solid #ddd;
            height: 400px;
            border-radius: 5px;
        }

        #name_tab {
            /* display: none; */
            width: 100%;
            padding-top: 10px;
            overflow-y: auto;
        }

        #ipn_tab {
            display: none;
            width: 100%;
        }

        #int_con_tre {
            width: 55%;
            float: left;
            height: 400px;
            border-right: 1px solid #ddd;
            overflow-y: auto;
            overflow-x: auto;
        }

        #p_con_lis {
            width: 45%;
            height: 400px;
            float: left;
            overflow-y: auto;
            margin-top: 0px;
        }

        .name_tab_lis {
            width: 100%;
            margin-top: 35px;
        }

            .name_tab_lis .name_tab_lis_check {
                width: 100%;
                padding: 5px;
            }

            .name_tab_lis .lis_tab {
                width: 100%;
                padding: 5px;
                margin-bottom: 5px;
            }

                .name_tab_lis .lis_tab img {
                }

        #p_con_lis .lis_tab img {
            width: 35px;
            height: 35px;
            border-radius: 50%;
        }

        #searchMessageBox {
            margin-left: 10px;
        }

        #name_tab_lis_all {
            float: left;
            margin-left: 10px;
        }

        .name_tab_lis .name_tab_lis_check .ch_txt {
            margin-left: 10px;
        }

        .name_tab_lis .lis_tab.active, .name_tab_lis .lis_tab:hover {
            background-color: #f3f3f3;
            position: relative;
        }

            .name_tab_lis .lis_tab.active:before {
                content: "\f00c";
                position: absolute;
                color: #3da6e0;
                font: normal normal normal 14px/1 FontAwesome;
                right: 15px;
                top: 15px;
            }

        .name_tab_lis img {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            margin-right: 10px;
            margin-left: 10px;
        }

        .messageAptdel {
            cursor: pointer;
        }

        section.content {
        }

        #dataTablesubtask .dataTables_empty {
            border-bottom: none !important;
        }

        #tab_model {
            padding: 10px 15px;
        }

        #dataTablesubtask.table > thead:first-child > tr:first-child > th, #dataTablesubtask .dataTables_empty {
            padding-left: 15px;
        }
    </style>
</head>
<!-- /Head -->
<!-- Body -->

<body style="background-color:Transparent;overflow:hidden;">
    <!-- 反馈 -->
    <div class="new_notice_feddbackMessage"></div>
    <div id="feddbackMessage_box" class="alert-shadow">
        <div class="headtit"><span style="font-size:15px;">反馈（请只针对本节点达成标准、指引、模板的不合理、不清晰等情况）</span><div class="pull-right" id="feddbackMessage_close"><i class="fa fa-fw fa-angle-down"></i></div></div>
        <div class="border-3 messageLBox_feddback">
            <textarea id="feddbackMessageTxt" rows="12" cols="" class="col-md-12 col-sm-12 col-xs-12" value="" placeholder="请输入您要反馈的内容"></textarea>
            <div id="messagefeddback"></div>
            <div class="pull-left"><div class="new_notice_alt" data-action="#messagefeddback"><span class="new_notice_txt">点击此处可以抄送给别人</span></div></div>
            <div class="pull-right messageLBtn" style="padding:3px 0;padding-right: 0px;margin-top: 20px;">
                <button type="button" id="feddbackExit" class="btn btn-primary bg-eee" style="font-size:12px;margin-right:15px">取消</button>
                <button type="button" id="savefeddback" class="btn btn-primary" style="font-size:12px;">发送</button>
            </div>
        </div>
    </div>
    <!-- @选择框 -->
    <div id="at_Message_box" class="alert-shadow">
        <div class="headtit"><span>选择成员</span><div class="pull-right" id="at_Message_box_close"><i class="fa fa-fw fa-close"></i></div></div>
        <div class="tab_s"><span class="show_tab active" data-action="#name_tab">姓名</span><span>|</span><span class="show_tab" data-action="#ipn_tab">部门</span></div>
        <div class="con_tab">
            <div id="name_tab">
                <div class="input-group input-group-sm pull-left" id="searchMessageBox" style="width:180px;">
                    <input class="form-control input-search" id="searchMessageBoxTxt" data-filter-name="projectName" placeholder="根据人员名称进行搜索" type="text">
                    <span class="input-group-addon no-left-radius" id="searchMessageBoxBtn"><i class="fa fa-search"></i></span>
                </div>
                <div id="name_tab_lis" class="name_tab_lis">
                    <div class="name_tab_lis_check"><input id="name_tab_lis_all" class="name_tab_lis_all" type="checkbox"><span class="ch_txt">全选</span></div>
                </div>
            </div>

            <div id="ipn_tab">
                <div id="int_con_tre">
                    <div id="Ztb" class="ztree"></div>
                </div>
                <div id="p_con_lis" class="name_tab_lis">
                    <div class="name_tab_lis_check"><input id="name_tab_lis_all2" class="name_tab_lis_all" type="checkbox"><span class="ch_txt">全选</span></div>
                </div>
            </div>
        </div>
    </div>
    <div class="container-box" style="width:800px;float:right;background:#fff;">

        <!-- Main Container -->
        <div class="wraper" style="top: 0px;position:relative;padding-left: 10px;background:#eee;">
            <div style="left:20px;float:right;width:800px;">

                <div class="box-header">
                    <div class="box-title">
                        <span>任务节点详情</span>
                    </div>
                    <div class="box-tools pull-right" id="boxBottonId" style="display: none;padding-right: 20px;">
                        <div class="btn-group" id="btnTaskId">
                            <a class="btn " id="completedTask" onclick="completedTask()" style="display:none;"><i class="fa fa-check"></i> 完成</a>
                            <a class="btn " id="addChildenTask" onclick="addChildenTask()" style="display:none;"><i class="fa fa-plus"></i> 新增子任务</a>
                            <a class="btn" id="removeGuide" onclick="removeGuide()" style="display:none;"><i class="fa fa-edit"></i> 移除</a>
                            <a class="btn" id="changeGuide" onclick="changeGuide()" style="display:none;"><i class="fa fa-edit"></i> 节点变更</a>
                        </div>
                    </div>
                    <div class="box-tools pull-right">
                        <button id="btnCloseDlg" class="btn btn-box-tool" data-widget="remove">
                            <i class="fa fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="row task-name-box" id="task-name-box">
                <i class="" id="icon-taskName"></i>&nbsp;&nbsp;<span property="taskName" id="taskNameById"></span>
            </div>
            <div class="row" style="margin-left: -10px;margin-right: -2px;">
                <div class="nav-tabs-custom" style="margin-bottom: 0px;">
                    <ul class="nav nav-tabs">
                        <li class="active"><a href="#tab_particulars" data-toggle="tab">详情</a></li>
                        <li><a href="#tab_dynamics" data-toggle="tab">留言板</a></li>
                        <li><a href="#tab_model" data-toggle="tab">模板&指引</a></li>
                        <li><a href="#tab_fruits" data-toggle="tab">工作成果</a></li>
                        <li><a href="#tab_log" data-toggle="tab">日志</a></li>
                    </ul>
                    <div class="tab-content">
                        <div class="tab-pane active" id="tab_particulars" isHasId="true">
                            <div class="row">
                                <div class="col-xs-12 col-md-12">
                                    <div class="box-body">
                                        <div class="form-title">
                                            <div class="CMY_form_item">
                                                <div class="row">
                                                    <label class="col-md-2 col-sm-2 col-xs-2 control-label pddingClass">阶段</label>
                                                    <div class="col-md-4 col-sm-4  col-xs-4 pddingClass">
                                                        <span property="stage" class="proj-info"></span>
                                                    </div>
                                                    <label class="col-md-2 col-sm-2 col-xs-2  control-label pddingClass">类别</label>
                                                    <div class="col-md-4 col-sm-4  col-xs-4 pddingClass">
                                                        <span property="category" class="proj-info"></span>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <label class="col-md-2 col-sm-2 col-xs-2  control-label pddingClass">责任主体</label>
                                                    <div class="col-md-4 col-sm-4  col-xs-4 pddingClass">
                                                        <span property="directorName" class="proj-info"></span>
                                                    </div>
                                                    <label class="col-md-2 col-sm-2 col-xs-2 control-label pddingClass ">执行主体</label>
                                                    <div class="col-md-4 col-sm-4  col-xs-4 pddingClass ex-max">
                                                        <span property="executeDept" title="" class="proj-info"></span>
                                                        <span>(<span property="executorName" class="proj-info"></span>)</span>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <label class="col-md-2 col-sm-2 col-xs-2  control-label pddingClass">标准计划开始</label>
                                                    <div class="col-md-4 col-sm-4  col-xs-4 pddingClass">
                                                        <span property="standardPlanStartDateStr" class="proj-info" id="standardPlanStartDate"></span>
                                                    </div>
                                                    <label class="col-md-2 col-sm-2 col-xs-2 control-label pddingClass ">标准计划结束</label>
                                                    <div class="col-md-4 col-sm-4  col-xs-4 pddingClass ex-max">
                                                        <span property="standardPlanEndDateStr" class="proj-info" id="standardPlanEndDate"></span>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <label class="col-md-2 col-sm-2 col-xs-2 control-label pddingClass">计划开始</label>
                                                    <div class="col-md-4 col-sm-4  col-xs-4 pddingClass">
                                                        <span property="planStartDate" id="planStartDateId" class="proj-info"></span>
                                                    </div>
                                                    <label class="col-md-2 col-sm-2 col-xs-2 control-label pddingClass ">计划结束</label>
                                                    <div class="col-md-4 col-sm-4  col-xs-4 pddingClass">
                                                        <span property="planEndDate" id="planEndDateId" class="proj-info"></span>
                                                    </div>
                                                </div>
                                                <div class="row" id="finishDateDivID">
                                                    <label class="col-md-2 col-sm-2 col-xs-2 control-label pddingClass">完成时间</label>
                                                    <div class="col-md-10 col-sm-10  col-xs-10 pddingClass">
                                                        <span property="finishDate" id="finishDateId" class="proj-info"></span>
                                                        <span id="spanAssessment" class="proj-info" title="" style="display:none;">(不纳入考核)</span>&nbsp;&nbsp;&nbsp;
                                                        <h:tag id="ExperienceSetTopTask">

                                                            <button id="editAssessment" type="button" class="btn btn-primary btn-info  btn-xs"><i class="fa fa-play"></i>&nbsp;纳入考核</button>

                                                        </h:tag>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <label class="col-md-2 col-sm-2 col-xs-2 control-label pddingClass"></label>
                                            </div>
                                            <div class="row">
                                                <label class="col-md-2 col-sm-2 col-xs-2 control-label pddingClass"></label>
                                            </div>
                                            <div class="row">
                                                <div class="z_label_box">
                                                    <div class="z_label_box_lit ">
                                                        <span id="labelCountId" class="col-md-2 col-sm-2 col-xs-2 control-label pddingClass"></span>
                                                        <span id="labelCountId" class="col-md-7 col-sm-7 col-xs-7 control-label pddingClass" style="width: 68.5%;"></span>
                                                        <a class="btn btn-default  labelCountId_dis_btn" style="margin-left: 15px" onclick="hideGantt()"><span id=spanIds>隐藏</span> <i class="fa fa-caret-right"></i></a>

                                                    </div>
                                                </div>
                                            </div>
                                            <div class="dataTablesubtask_box">
                                                <table id="dataTablesubtask" class="table table-bordered table-hover table-striped">
                                                    <thead class="bordered-darkorange">
                                                        <tr role="row">
                                                            <th class="tableHead ">完成状态</th>
                                                            <th width="220px" class="tableHead ">子任务</th>
                                                            <th width="" class="tableHead">负责人</th>
                                                            <th width="" class="tableHead">结束时间</th>
                                                        </tr>
                                                    </thead>
                                                </table>
                                            </div>
                                            <div class="row"></div>
                                            <div class="row"></div>
                                            <div class="row Experiencebox">
                                                <input type="hidden" id="achieveStandardIds" value="" />
                                                <div class="col-md-12 col-sm-12 CMY_btnMoreExperience" style="padding: 0 !important;margin-top:30px;">
                                                    <div class="col-md-12 col-sm-12 col-xs-12" style="height: 45px;line-height: 16px;background-color: #f5f5f5;">
                                                        <span class="col-md-5 col-sm-5 col-xs-5 pddingClass box-header-title" style="padding-left:5px;">经验分享</span>
                                                        <span class="col-md-7 col-sm-7 col-xs-7 control-label pddingClass" style="padding-right: 20px;padding-top: 7px;">
                                                            <span>
                                                                <form id="" class="form-horizontal" onsubmit="return false">
                                                                    <div class="input-group input-group-sm " id="searchBox" style="width:300px;">
                                                                        <input type="text" class="form-control input-search" id="keyword" placeholder="请输入项目经理姓名或项目名称">
                                                                        <span class="input-group-btn">
                                                                            <button type="button" class="btn btn-flat" id="btnSearch"><i class="fa fa-search"></i></button>
                                                                        </span>
                                                                    </div>
                                                                </form>
                                                            </span>
                                                        </span>

                                                    </div>
                                                    <div class="boxId col-md-12 col-sm-12 col-xs-12 no-padding-both" id="CMY_expShare">

                                                        <table id="dataTable" class="table table-bordered table-hover table-striped">
                                                            <thead class="bordered-darkorange">
                                                                <tr role="row">
                                                                    <th width="50" class="tableHead text-center"> </th>
                                                                    <th width="150" class="tableHead  text-center">名称</th>
                                                                    <th width="150" class="tableHead  text-center">管辖区域</th>
                                                                    <th width="100" class="tableHead text-center" style="text-align:center">项目经理</th>
                                                                    <th width="" class="tableHead text-center">经验详情</th>
                                                                </tr>
                                                            </thead>
                                                        </table>
                                                        <!-- Modal -->

                                                    </div>
                                                </div>
                                            </div>

                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="tab-pane" id="tab_dynamics">
                            <div id="tab_dynamicsSlBar">
                                <div class="row border-3 messageLBox">
                                    <textarea id="txtId" rows="3" cols="" class="col-md-12 col-sm-12 col-xs-12" value="" placeholder="请输入您要留言的内容"></textarea>
                                    <div id="messageApt"></div>
                                    <div class="pull-left" class="message_a_alert "><div class="new_notice_alt" data-action="#messageApt"><span class="new_notice_txt">点击此处可以抄送给别人</span></div></div>
                                    <div class="pull-right messageLBtn" style="padding:3px 0;padding-right: 0px;">
                                        <button type="button" onclick="clearMessege()" class="btn btn-primary bg-eee" style="font-size:12px;margin-right:15px">取消</button><button type="button" onclick="sendMessege()" class="btn btn-primary" style="font-size:12px;">发送</button>
                                    </div>

                                </div>
                                <div class="box box-danger direct-chat direct-chat-danger" style="border-radius: 0px;">
                                    <div class="box-body" style="padding: 0; padding-top: 0px;">
                                        <div class="direct-chat-messages" id="showTaskNewId" style="margin:0;padding:1px">
                                            <!-- <pre id="showTaskNewId" >
                                            </pre> -->
                                        </div>
                                    </div>
                                    <div id="taskMessage" style="color: blue;text-align: center;"><a href="javascript:void(0)" onclick="getFeedbackDate()">查看更多</a></div>
                                </div>
                            </div>
                        </div>
                        <div class="tab-pane" id="tab_model">
                            <div id="tab_model_slbar">
                                <div class="row">
                                    <div class="col-md-12 col-sm-12 col-xs-12 border-3" style="background:#fff;border:1px solid #ddd;padding-left:0;padding-right:0">
                                        <div class="col-md-12 col-sm-12 col-xs-12 bg-color-f5" style="padding:10px;border-bottom:1px solid #ddd;">
                                            <span class="box-header-title">达成标准</span>
                                        </div>
                                        <div class="col-md-12 col-sm-12 col-xs-12" id="editorDivId" style="padding:10px;word-break:break-all;word-wrap:break-word;">
                                            <!-- <script id="editor" type="text/plain" style="width:100%;height:249px;"></script> -->
                                            <span id="achieveStandardId"></span>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-12 col-sm-12 col-xs-12 border-3" style="background:#fff;border:1px solid #ddd;padding-left:0;padding-right:0;margin-top:30px">
                                        <div class="col-md-12 col-sm-12 col-xs-12 bg-color-f5" style="padding:10px;border-bottom:1px solid #ddd;">
                                            <span class="box-header-title">指引</span>
                                        </div>
                                        <div class="col-md-12 col-sm-12 col-xs-12" id="editorDivId" style="padding:10px;word-break:break-all;word-wrap:break-word;">
                                            <!-- <script id="editor" type="text/plain" style="width:100%;height:249px;"></script> -->
                                            <span id="editorDivIds"></span>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-12 col-sm-12 col-xs-12 border-3" style="background:#fff;border:1px solid #ddd;padding-left:0;padding-right:0;margin-top:30px">
                                        <div class="col-md-12 col-sm-12 col-xs-12 bg-color-f5" style="padding:10px;border-bottom:1px solid #ddd">
                                            <span class="box-header-title">模板</span>
                                        </div>
                                        <div class="col-md-12 col-sm-12 col-xs-12" style="padding: 0;">
                                            <table class="table table-bordered table-hover table-striped">
                                                <thead class="bordered-darkorange">
                                                    <tr role="row">
                                                        <th>文件名</th>
                                                        <th>创建人</th>
                                                        <th>创建时间</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="resourceListBox"></tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="tab-pane" id="tab_fruits">
                            <div class="taskAchieve row" id="taskAchieve">
                                <div class="col-md-12 col-sm-12 col-xs-12 border-3" style="background:#fff;border:1px solid #ddd;padding-left:0;padding-right:0;">
                                    <div class="col-md-12 col-sm-12 col-xs-12" style="padding:10px;border-bottom:1px solid #ddd;    background-color: #f5f5f5;">
                                        <span class="box-header-title">经验分享</span>
                                    </div>
                                    <div class="col-md-12 col-sm-12 col-xs-12" style="padding:10px;" id="taskExperience"></div>
                                </div>
                                <div class="col-md-12 col-sm-12 col-xs-12 border-3" style="background:#fff;border:1px solid #ddd;padding-left:0;padding-right:0;margin-top: 30px;">
                                    <div class="col-md-12 col-sm-12 col-xs-12" style="padding:10px;border-bottom:1px solid #ddd;    background-color: #f5f5f5;">
                                        <span class="box-header-title">上传文件</span>
                                    </div>
                                    <div class="col-md-12 col-sm-12 col-xs-12" style="padding:0px;min-height: 20px;">
                                        <table class="table table-bordered table-hover table-striped nomargin">
                                            <thead class="bordered-darkorange">
                                                <tr role="row">
                                                    <th>文件名</th>
                                                    <th width="100">自定义文件名</th>
                                                    <th width="180">上传时间</th>
                                                    <th width="100">上传人</th>
                                                    <th width="200">操作</th>
                                                </tr>
                                            </thead>
                                            <tbody id="achieveListBox" class="isMust"></tbody>
                                        </table>
                                    </div>

                                    <table class="table table-bordered table-hover table-striped nomargin">
                                        <thead class="bordered-darkorange">
                                            <tr role="row">
                                                <th></th>
                                                <th>自定义文件名</th>
                                                <th width="180">上传时间</th>
                                                <th width="100">上传人</th>
                                                <th width="200">操作</th>
                                            </tr>
                                        </thead>

                                        <tbody style="border-top:none;" id="resourceOtherTempBox"></tbody>

                                        <tbody class="uploadTbdy">
                                            <tr>
                                                <td></td>
                                                <td></td>
                                                <td></td>
                                                <td></td>
                                                <td class="wd100">
                                                    <p class="pull-right" style="padding-right:20px;"><span id="btnUpload" class=""><i class="fa fa-upload"></i> 其它附件</span></p>
                                                </td>
                                            </tr>
                                        </tbody>


                                        <!-- end -->
                                    </table>
                                    <span class="pull-right" style="padding-bottom:5px" id="file_max_size"></span>
                                </div>
                                <!-- <iframe id="iframeTaskAchId" frameborder="0" scrolling="no"
                                    width="100%" height="350px" src=""></iframe> -->
                            </div>
                        </div>
                        <div class="tab-pane" id="tab_log">
                            <div class="logList" id="logListBox"></div>
                        </div>
                    </div>
                    <!-- /tab-content -->
                </div>
            </div>
        </div>
    </div>
    <div id="tmplTip" class="t2m-filter-box box box-widget alert-shadow" style="width: 320px!important;display: none;border:none;margin:0;overflow-y: auto;z-index:4000;padding:0"> </div>

    <iframe id="downLoadIframe" style="display:none;"></iframe>
    <%@include file="../../common/admin_js.jsp"%>
    <!-- 员工信息 -->
    <!--<i class="fa fa-times"></i>  -->
    <script id="staffInfoTmpl" type="text/html">
        <div class="t-user-box-alert">
            <div class="t-user-box-alert-top"><button type="button" class="btn btn-box-tool pull-right" data-widget="remove"><i class="fa fa-times"></i></button></span></div>
            <div class="t-user-box-alert-cox">
                <div class="t-userm-mes">
                    <div class="t-u-img">
                        <!--<img class="img-circle" src="${"$"}{headimgurl}" onerror="this.src='${contextPath}/static/images/no-pic-1.png'">-->
                        <img class="img-circle" src="${" $"}{headimgurl}" onerror="this.src='${contextPath}/static/images/no-pic-1.png'">
                    </div>
                    <div class="t-u-txt">
                        <div class="t-u-t">${"$"}{cname}</div>
                        <div class="t-u-p">${"$"}{dname}</div>
                    </div>
                </div>
                <div class="t-user-details">
                    <div class="t-user-opp">
                        <span>手机: </span><span>${"$"}{mobile}</span>
                    </div>
                    <div class="t-user-opp">
                        <span>邮箱: </span><span>${"$"}{email}</span>
                    </div>
                </div>
            </div>
        </div>
    </script>
    <script type="text/javascript" src="${contextPath}/static/jqplugins/jquery.tmpl.js?version=2.1.1530843110000"></script>
    <link rel="stylesheet" href="${contextPath}/static/webuploader/webuploader.css?version=2.1.1530843110000">
    <script type="text/javascript" src="${contextPath}/static/webuploader/webuploader.min.js?version=2.1.1530843110000"></script>
    <!--ztree  -->
    <link rel="stylesheet" href="${contextPath}/static/Ztree/css/zTreeStyle/zTreeStyle.css?version=2.1.1530843110000" type="text/css">
    <link href="${contextPath}/static/style/ztree/ztree-icon.css?version=2.1.1530843110000" rel="stylesheet" />
    <script type="text/javascript" src="${contextPath}/static/Ztree/js/jquery.ztree.core.js?version=2.1.1530843110000"></script>
    <script type="text/javascript" src="${contextPath}/static/Ztree/js/jquery.ztree.exhide.min.js?version=2.1.1530843110000"></script>
    <script type="text/javascript" src="${contextPath}/static/Ztree/js/fuzzysearch.js?version=2.1.1530843110000"></script>
    <!-- 人员信息 弹窗-->
    <!-- 工作成果列表模板  -->
    <script id="resourceWorkList" type="text/html">
        <tr>
            {{if tempFileName.length>10}}
            <td class="txt" title="${" $"}{tempFileName}">${"$"}{tempFileName.substr(0,10)}...</td>
            {{else}}
            <td class="txt">${"$"}{tempFileName}</td>
            {{/if}}
            <td class="txt">
                {{if fileName.length>9}}
                <a title="${" $"}{fileName}" onclick=downLoadTask('${"$"}{resourceId}')>${"$"}{fileName.substr(0,9)}...</a>
                {{else}}
                <a onclick=downLoadTask('${"$"}{resourceId}')>${"$"}{fileName}</a>
                {{/if}}
            </td>
            <td class="txt">${"$"}{createTime}</td>
            <td>${"$"}{createUserName}</td>
            <td class="txt">
                {{if resourceId!=null}}
                <span class='upload lisbtn' id="picker_edit_${" $"}{resourceId}" resourceId="${" $"}{resourceId}" tempNodeResourceId="${" $"}{tempNodeResourceId}">重新上传</span><span class="mid-line-h">|</span> <span class="lisbtn del" onclick=deleteTaskResource('${"$"}{resourceId}')>
                    删除</sapn>
                    {{else}}
                    <span class='upload lisbtn' id="picker_add_${" $"}{tempNodeResourceId}" tempNodeResourceId="${" $"}{tempNodeResourceId}">上传</span>
                    {{/if}}
            </td>
        </tr>
    </script>
    <script id="resourceShareist" type="text/html">
        <div class="box-comment">
            <img class="img-circle img-sm" src="${" $"}{createHeadimgurl}" onerror="this.src='${contextPath}/static/images/no-pic-1.png'">
            <div class="comment-text experience-item" data="${" $"}{experienceId}">
                <span class="username" style="font-size:14px;color:#333;font-weight:normal;">
                    ${"$"}{projectManagerCname}
                    <span id="count" class="text-muted pull-right" style="font-size:13px;color:#999;">评论&nbsp${"$"}{countComment}</span>
                    <p style="font-size:14px;color:#999;">${"$"}{createTime}</p>
                </span>
                <span class="item-projectname">${"$"}{projectName}</span>
            </div>
        </div>
    </script>
    <script id="tmpLogList" type="text/html">
        <div class="direct-chat-messages" style="background-color: #eee">
            <div class="direct-chat-msg">
                <div class=" pull-left"></div>
                <img class="direct-chat-img" src="${" $"}{createHeadimgurl}" onerror="this.src='${contextPath}/static/images/no-pic-1.png'">
                <div>
                    <div class="direct-chat-info clearfix  pull-left " style="width: calc(100% - 40px);">
                        <div class="direct-chat-info-con-us">
                            <span class="direct-chat-name pull-left">${"$"}{createUserName}</span>
                            <span class="direct-chat-timestamp pull-right">${"$"}{createTime}</span>
                        </div>
                        <div class="direct-chat-info-con-text">
                            <input type="hidden" value="${" $"}{modelType}" />
                            {{if modelType==4}}
                            ${"$"}{content.title}：${"$"}{content.taskTitle}<br />
                            {{each(i,log) content.list}}
                            将${"$"}{label} 从 ${"$"}{old} 更新为 ${"$"}{newObj}<br />
                            {{/each}}
                            {{else}}
                            ${"$"}{content.title}<br />
                            {{each(i,log) content.list}}
                            将${"$"}{label} 从 ${"$"}{old} 更新为 ${"$"}{newObj}<br />
                            {{/each}}
                            {{/if}}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </script>
    <script id="resourceNewsList" type="text/html">
        <div class="direct-chat-msg">
            <img class="direct-chat-img" src="${" $"}{headImgUrl}" onerror="this.src='${contextPath}/static/images/no-pic-1.png'">
            <div class="direct-chat-text" style="text-align:left;">
                <span class="direct-chat-name pull-left">${"$"}{cname}：</span>{{html remindingStaffId}} {{html  content}}
                <div class="direct-chat-info clearfix">
                    <span class="direct-chat-timestamp">${"$"}{createTime}</span>
                </div>
            </div>

        </div>
    </script>
    <script id="resourceTempList" type="text/html">
        <tr>
            <td><a onclick=downLoad('${"$"}{resourceId}')>${"$"}{fileName}</a></td>
            <td>${"$"}{createUser}</td>
            <td>${"$"}{createTime}</td>
        </tr>
    </script>
    <script id="childenTbodyTaskList" type="text/html">
        <tr>
            <td><i class="fa  fa-check-circle" style="font-size:20px;color:green;"></i><a onclick=childenEidt('${"$"}{subTaskId}')>${"$"}{title}</a></td>
            <td>${"$"}{cname}</td>
            <td>${"$"}{subTaskStart}</td>
            <td>${"$"}{subTaskEnd}</td>
        </tr>
    </script>
    <!-- 艾特@ -->
    <script id="tmp_lis_tab" type="text/html">
        <div class="lis_tab" data-id="${" $"}{staffId}" data-name="${" $"}{cname}">
            <img alt="" src="${" $"}{headimgurl}" onerror="this.src='${contextPath}/static/images/no-pic-1.png'">
            <span class="name">${"$"}{cname}(${"$"}{loginName})${"$"}{contentReplace(deptName)}</span>

        </div>
    </script>
    <script id="tmp_lis_tab2" type="text/html">
        <div class="lis_tab" data-id="${" $"}{STAFF_ID}" data-name="${" $"}{CNAME}">
            <img alt="" src="${" $"}{HEADIMGURL}" onerror="this.src='${contextPath}/static/images/no-pic-1.png'">
            <span class="name">${"$"}{CNAME}</span>
        </div>
    </script>

    <script type="text/javascript">
	 	/* var ue = UE.getEditor('editor',{
			 toolbars:[],
			 readonly:true,
			 wordCount:false
		 }); */
		/* 判断是否区域运营角色  1 是区域运营  2不是区域运营 3总部运营   sar
		1 区域运营：可以给已完成的节点上传、删除、重新上传附件
		3 总部运营：可以给全部的节点上传、删除、重新上传附件；
		*/
		var  isRegionalOperationRole="${isRegionalOperationRole}";
		var approvalState;
		var taskInfo;
		var projectData;
		var _$DataDrawCount = 1;
		function ganttFunction(iframeHeight){
		    //var src="${contextPath}/ppm/subTaskInfo/toGantt?taskId="+${param.taskId};
		    //$("#toGanttId").attr('src',src);
		    $("#toGanttId").height(iframeHeight);
		    if(iframeHeight<40){
		    	$("#toGanttId").height(40);
		    }
		    hideLoading();
		}

		function downLoad(resourceId){
			$("#downLoadIframe").attr("src","${contextPath}/file/ajax/download?resourceId="+resourceId+"&service=tempNodeResourseInfo");
			//location.href="${contextPath}/file/ajax/download?resourceId="+resourceId+"&service=tempNodeResourseInfo";
		}
		function downLoadTask(resourceId){
			$("#downLoadIframe").attr("src","${contextPath}/file/ajax/download?resourceId="+resourceId+"&service=taskResourceInfo");
			//location.href="${contextPath}/file/ajax/download?resourceId="+resourceId+"&service=taskResourceInfo";
		}
		function childrenTask(){
			$.ajax({
	       		url:"${contextPath}/ppm/subTaskInfo/ajax/countSubTask",
	       		data:{taskId:"${param.taskId}"},
	       		type:"post",
	       		cache:false,
	       		success:function(res){
	       			$("#labelCountId").css({"font-size":"16px","color":"#333"}).text("子任务("+res+")");
	       		}
	       	});

		}
		/* $("#toGanttId").on("load",function(){//iframe加载完后 高度自适应。
			var iframeHeight = $("#toGanttId").contents().find("#right_frame_h").height();
			//alert(iframeHeight);
			$("#toGanttId").height(iframeHeight);
		});
		*/

		/*
		function tempNodeGuide(){
		 	$.ajax({
       			url:"${contextPath}/ppm/tempNodeInfo/ajax/loadTempNodeInfoById",
       			data:{taskId:"${param.taskId}"},
       			type:"post",
       			cache:false,
       			success:function(res){
       				//alert(res.data.guide);
       				$("#editorDivIds").html(res.data.guide);
       				//$("#labelCountId").css({"font-size":"16px","color":"#333"}).text("子任务("+res+")");
       			}
       		});
		}
		*/
		function toLogList(){
		 	$("#logListBox").html("");
			$.ajax({
     			url:"${contextPath}/ppm/taskLogInfo/ajax/listTaskLogInfo",
     			data:{taskId:"${param.taskId}"},
     			async:false,
     			success:function(res){
     				for(var i=0;i<res.data.length;i++){
     					//console.log(res.data[i].content);
     					res.data[i].content=JSON.parse(res.data[i].content);
     				}
     				//填充文件列表
     				$("#tmpLogList").tmpl(res.data).appendTo("#logListBox");
     				//加载数据字典
     				//loadDicts(res.data);
     				//hideLoading();

     			}
     		});
		}
		function contentReplace(deptName) {

			deptName = deptName.replace(/<br\/>/g,'，');
			if (deptName) {
				deptName = " - "+deptName
			}
			return deptName
		}

		var IsAssessment=null;

		$(document).ready(function() {
			initPage();
			//isTaskToApprove();
			//初始化高度
			//$(".tab-pane").height($(window).height()-$(".navbar").height()-$(".task-name-box").height()-$(".nav-tabs").height()-80);
			//addTaskName();
			//tempNodeGuide();
			approFun();
			iframeTaskAchId();
			childrenTask();
			loadTaskNews();
			toLogList();

      	 	//加载数据
       		$.ajax({
       			url:"${contextPath}/ppm/tempNodeResourseInfo/ajax/listTempNodeResourseInfo",
       			data:{taskId:"${param.taskId}",tempNodeId:taskInfo.tempNodeId},
       			type:"post",
       			cache:false,
       			success:function(res){

       				//填充文件列表
       				/* if(res.data.fileStoragePath!=null){
       					res.data.fileStoragePath.replace("http://222.180.200.126:8087", "D:");
       				} */
       				//alert(res.data.length);
       				$("#resourceTempList").tmpl(res.data).appendTo("#resourceListBox");

       			}
       		});
       		$('a[data-toggle="tab"]').on("shown.bs.tab", function(e){
	       		var tab = $(e.currentTarget).html();
	       		if (tab=="工作成果"){
		       		reloadUp();
	       		}
       		});
       		//tempNodeGuide();
       		//shareAjax();
       		$("#btnMoreExperience").on("click",function(){
       			var src="${contextPath}/ppm/taskExperienceInfo/toTaskExperienceInfoList?taskId=${param.taskId}";//+"&achieveStandard="+achieveStandard;

			    top.showTopDialogs('经验列表',src,20,900,550,[{
    	   			caption:"&times;",
    	   			className:"btn",
    	   			click:function(){
    	   				this.closeDlg();
    	   			}
    	   		}
			   ],window);
			   });


				//编辑考核状态
			   $('#editAssessment').on("click",function(){
				   if(IsAssessment==null)
				   {
					   return ;
				   }
					$.ajax({
						url:"${contextPath}/ppm/projectTaskInfo/ajax/editAssessment",
						data:{taskId:"${param.taskId}",IsAssessment:IsAssessment},
						type:'POST',
						cache:false,
       					async:false,
						success:function(res){
							if(res.state==0)
							{
								IsAssessment=!IsAssessment;
								AssessmentBtn(IsAssessment);
							}
						}
					});
				});
		});
		/* function tempNodeGuide(){
			$.ajax({
       			url:"${contextPath}/ppm/tempNodeInfo/ajax/loadTempNodeInfoById",
       			data:{taskId:"${param.taskId}"},
       			type:"post",
       			cache:false,
       			success:function(res){
       				if(res.state==0){
       				//异步回调
	       				if(res.data.guide==null||res.data.guide==""){
	       					$("#editorDivId").hide();
	       				}else{
	       					ue.ready(function() {
	       	      	   	        ue.execCommand('inserthtml', res.data.guide);
	       	      	   	    });

	       				}
       				}
       			}
       		});
		} */


		function AssessmentBtn(Assessment)
		{
			if(Assessment==null)
			{
				$('#editAssessment').hide();
			}
			else if(Assessment)
			{
				$("#spanAssessment").show();
				$('#editAssessment').addClass('btn-info').html('<i class="fa fa-play"></i>&nbsp;纳入考核');

			}
			else{
				$("#spanAssessment").hide();
				$('#editAssessment').removeClass('btn-info').html('<i class="fa fa-pause"></i>&nbsp;不纳入考核');
			}
		}

		function reloadUp(){
			reloadResource();
			//初始化上传控件
	   		if (!window.hasInitUploader){
	   			if (taskInfo.approvalState==1 || !(isProjectManager() || isTaskExecutor())) {
   					$("#btnUpload").hide();
   				} else {
		       		/* initUploader("btnUpload",function(res){
		   	     		if(res.state==0){
		   	     			var data={taskId:"${param.taskId}",fileName:res.fileName,fileStoragePath:res.path};
		   	     			var url="${contextPath}/ppm/taskResourceInfo/ajax/saveTaskResourceInfo";
		   	     			$.ajax({
				   	 			url:url,
				   	 			data:data,
				   	 			success:function(res){
				   	 				reloadResource();
				   	 			}
				   	     	});
		   	 	    	}
			    	}); */
   				}
	   		}
	   		//初始化上传控件
	   		var FliseSize = $.cookie("JinkeFileMaxSize");
	   		//console.log(FliseSize +"xxxxxxx");
	   		$("#file_max_size").text("所选附件大小 不可超过"+(parseInt(FliseSize*100)/100)+"KB");
	   		if (!window.hasInitUploader){
	   			if (taskInfo.approvalState==1 || !(isProjectManager() || isTaskExecutor())) {
   					$("#btnUpload").hide();

   				} else {
		       		initUploader("btnUpload",function(res){
		   	     		if(res.state==0){
		   	     			var data={taskId:"${param.taskId}",fileName:res.fileName,fileStoragePath:res.path,fileSize:res.fileSize};
		   	     			var url="${contextPath}/ppm/taskResourceInfo/ajax/saveTaskResourceInfo";
		   	     			$.ajax({
				   	 			url:url,
				   	 			data:data,
				   	 			success:function(res){
				   	 				reloadResource();
				   	 			}
				   	     	});
		   	 	    	}
			    	});
   				}
	   			if(isRegionalOperationRole==3||(isRegionalOperationRole==1&&taskInfo.state==6)){
	   				//console.log(isRegionalOperationRole)
	   				$("#btnUpload").show();
	   				initUploader("btnUpload",function(res){
		   	     		if(res.state==0){
		   	     			var data={taskId:"${param.taskId}",fileName:res.fileName,fileStoragePath:res.path,fileSize:res.fileSize};
		   	     			var url="${contextPath}/ppm/taskResourceInfo/ajax/saveTaskResourceInfo";
		   	     			$.ajax({
				   	 			url:url,
				   	 			data:data,
				   	 			success:function(res){
				   	 				reloadResource();
				   	 			}
				   	     	});
		   	 	    	}
			    	});
	   			}
	   		}
			window.hasInitUploader=true;
		}

		function shareAjax(){
			//return false;
			$("#expShareId").html("");
			$.ajax({
       			//url:"${contextPath}/ppm/taskExperienceInfo/ajax/listTaskExperienceInfo",
       			url:"${contextPath}/ppm/taskExperienceInfo/ajax/loadTaskExperienceProjectList",
       			data:{taskId:"${param.taskId}",length:4},
       			//type:"post",
       			cache:false,
       			success:function(res){
       				//alert(res.data.length);
       				/* var array=new Array();
       				for (var i=0;i<4;i++)
       				{
       					array.push(res.data[i]);
       				} */
       				$("#resourceShareist").tmpl(res.data).appendTo("#expShareId");
       				$("#expShareId").find(".experience-item").on("click",function(){
       					var projName = $(this).find(".item-projectname").text();
       					//var projName=$("#taskNameById").text();
       					if (!projName){
       						projName="经验详情";
       					}
       					var expId=$(this).attr("data");
       					var src="${contextPath}/ppm/taskExperienceInfo/showTaskExperienceInfo?experienceId="+expId;//+"&achieveStandard="+achieveStandard;
       			    	top.showTopDialogs(projName,src,20,700,550,[{
       	    	   			caption:"&times;",
       	    	   			className:"btn",
       	    	   			click:function(){
       	    	   				this.closeDlg();
       	    	   			}
       	    	   		}
       				   ],window);
       				});
       			},
       			"dataType":"JSON"
       		});
		}

		//获取项目信息后，填充到项目界面中
	    function fillNodeInfo(data){
	    	for (var key in data) {
	    		if (data[key] != null) {
	    			$("span[property='"+key+"']").text(data[key]);
	    		} else {
	    			$("span[property='"+key+"']").text("");
	    		}

	    		 if(key=="achieveStandard"){
	    			 $("#achieveStandardId").html(data[key]);
	    			 $("#achieveStandardIds").val(data[key]);
	    		} else if (key=="guide"){

	    			$("#editorDivIds").html(data[key]);
	    		}
	    	}
	    	//设置任务图标
	    	//icon-taskName
	    	var $icon=$("#icon-taskName");
	    	var clsName="",color="0a0";
	    	if (data.overdueFlag==1){
	    		clsName="fa fa-exclamation-circle";
	    		color="#f90";
	    	} else {
	    		if (data.approvalState==2){
	    			clsName="fa fa-question-circle";
		    		color="brown";
	    		} else {
	    			if (data.state==4){
	    				clsName="fa fa-hourglass-start";
			    		color="#0a0";
	    			} else if (data.state==5){
	    				clsName="fa fa-clock-o";
			    		color="#0a0";
	    			} else if (data.state==6){
	    				clsName="fa fa-check-circle";
			    		color="#0a0";
	    			}
	    		}
	    	}
	    	$icon.removeClass();
	    	$icon.addClass(clsName).css("color",color);
	    	//若任务已完成，则获取任务的经验
	    	if (data.state==6){
	    		$.ajax({
	    			url:"${contextPath}/ppm/taskExperienceInfo/ajax/loadTaskExperienceInfoByOne",
	    			data:{taskId:data.taskId},
	    			success:function(res){

	    				$("#taskExperience").html(res.data.content);
	    			}
	    		});
	    	}
	    }
	    function completedTask(){
	    	var taskId=${param.taskId};
	    	var achieveStandard=$("#achieveStandardIds").val();

	    	var src="${contextPath}/ppm/tempNodeInfo/toCompletedTask?taskId="+${param.taskId};//+"&achieveStandard="+achieveStandard;
	    	//top.showTopDialogs('完成任务',src,20,740,550,null,window);
	    	top.showTopDialogs('完成任务',src,50,800,550,[
    			{
    	   			caption:"提交审核",
    	   			className:"btn",
    	   			icon:"fa fa-floppy-o",
    	   			click:function(){
    	   				this.iframe.contentWindow.submitTask(this.win);
    	   			}
    	   		},
    	   		{
    	   			caption:"&times;",
    	   			className:"btn",
    	   			click:function(){
    	   				this.iframe.contentWindow.closeTask(this);
    	   				//this.closeDlg();
    	   			}
    	   		}],window);
	    	//showModalDialog(src,'完成任务',0,500,100);
	    }


	    function loadTaskNews(check){
	    	if (!check) {
	    		$("#showTaskNewId").html("");
	    	}

	    	var formData = getFilterParam();


	    	$.ajax({
       			url:"${contextPath}/sys/messageInfo/getRemindingList",
       			data:formData,
       			type:"post",
       			dataType:"json",
       			async:false,
       			success:function(result){
       				if(!result.data){
       					$("#showTaskNewId").css({"text-align":"center","height":"23px"}).text("暂无留言");
       				}else{
       					$("#resourceNewsList").tmpl(result.data).appendTo("#showTaskNewId");
       				}

       				if(((formData.start+formData.length)>=result.recordsTotal) || (result.recordsTotal <= formData.length)){
       	        		//这里需要禁用查看更多
       	        		$("#taskMessage").hide();
       	        	} else {
       	        		$("#taskMessage").show();
       	        	}
       				dataTableScrollBar($("#tab_dynamics"),"",true);
       			}
       		});
	    }
	    //查看更多
	    function getFeedbackDate() {
	    	_$DataDrawCount=_$DataDrawCount+1;
	    	var check = "all";
	    	loadTaskNews(check);
	    	//dataTableScrollBar($("#tab_dynamics"));
	    }
		/**
		 * 统一收集参数
		 */
		 var getFilterParam=function(){
			var dataParam={};
			// length 即 pageSize
			var length = 10;
			var start  = (_$DataDrawCount-1)*length;
			dataParam.start = start;
			dataParam.length = length;
			dataParam.draw = 1;
			dataParam.taskId = "${param.taskId}";

			return dataParam;
		}


	    function iframeTaskAchId(){
	    	var src="${contextPath}/ppm/taskAchievementInfo/listTaskAchievementInfo?taskId="+"${param.taskId}";
	    	$("#iframeTaskAchId").attr("src",src);
	    }
	    //留言
	    function sendMessege(){
	    	//dataTableScrollBar($("#tab_dynamics"));
	    	if($("#txtId").val()==null||$("#txtId").val()==""||$("#txtId").val().length<1){
	    		top.bootbox.alert({buttons: {ok:{label: '确定',className:'btn-primary'}},message: '留言内容不能为空！',});
	    		return;
	    	}
	    	var str1=$("#txtId").val().replace(/\r{0,}\n/g,"<br/>").replace(/\s/g,"&nbsp;");
	    	var remindingStaffId = allRemindingStaffId("#messageApt");

	    	$.ajax({
       			url:"${contextPath}/sys/messageInfo/saveMessageReminding",
       			data:{taskId:"${param.taskId}",content:str1,'remindingStaffId':remindingStaffId},
       			type:"post",
       			cache:false,
       			success:function(res){
       				$("#txtId").val("");
       				$("#messageApt").html("");

       				loadTaskNews();
       				altStatInit();
       				toLogList();

       			}
       		});
	    	$("#txtId").val("");
	    }
	    function clearMessege(){
	    	$("#txtId").val("");
	    	$("#messageApt").html("");
	    }

	    $("#btnCloseDlg").click(function(){
      		 parent.hideDetail();
      	});

	    function changeGuide(){
	    	//var taskId=${param.taskId};
	    	//var achieveStandard=$("#achieveStandardId").text();
	    	approFun();
	    	//alert(approvalState);
	    	var src="${contextPath}/ppm/projectTaskInfo/toEditProjectTaskInfoDetail?taskId="+${param.taskId};
	    	/* if(approvalState==4){
	    		top.showTopDialogs('变更业务节点',src,20,700,550
		    			,[{
		    	   			caption:"同意",
		    	   			className:"btn",
		    	   			icon:"fa fa-floppy-o",
		    	   			click:function(){
		    	   				this.iframe.contentWindow.consentTask();

		    	   			}
		    	   		  },
		    	   		{
			    	   			caption:"打回",
			    	   			className:"btn",
			    	   			icon:"fa fa-reply",
			    	   			click:function(){
			    	   				this.iframe.contentWindow.backTask();
			    	   			}
			    	   		  },
		    	   		{
		    	   			caption:"&times;",
		    	   			className:"btn",
		    	   			click:function(){
		    	   				this.closeDlg();
		    	   			}
		    	   		}]
		    			,window);
	    	}else{ */
    		top.showTopDialogs('变更业务节点',src,50,700,550
	    			,[{
	    	   			caption:"提交审核",
	    	   			className:"btn",
	    	   			icon:"fa fa-floppy-o",
	    	   			click:function(){
	    	   				this.iframe.contentWindow.submitTask(this.win);
	    	   			}
	    	   		},
	    	   		{
	    	   			caption:"&times;",
	    	   			className:"btn",
	    	   			click:function(){
	    	   				//closeDialog();
	    	   				this.closeDlg();
	    	   			}
	    	   		}]
	    			,window);

	    }

	    function removeGuide(){
	    	approFun();
	    	var src="${contextPath}/ppm/projectTaskInfo/removeProjectTaskInfo?taskId="+${param.taskId};
	    	if(approvalState==4){
	    		top.showTopDialogs('移除业务节点',src,50,700,550
		    			,[{
		    	   			caption:"同意",
		    	   			className:"btn",
		    	   			icon:"fa fa-floppy-o",
		    	   			click:function(){
		    	   				this.iframe.contentWindow.consentTask(this);

		    	   			}
		    	   		  },
		    	   		{
			    	   			caption:"打回",
			    	   			className:"btn",
			    	   			icon:"fa fa-reply",
			    	   			click:function(){
			    	   				this.iframe.contentWindow.backTask(this);
			    	   			}
			    	   		  },
		    	   		{
		    	   			caption:"&times;",
		    	   			className:"btn",
		    	   			click:function(){
		    	   				this.closeDlg();
		    	   			}
		    	   		}]
		    			,window);
	    	}else{
	    		top.showTopDialogs('移除业务节点',src,50,700,550
		    			,[{
		    	   			caption:"提交审核",
		    	   			className:"btn",
		    	   			icon:"fa fa-floppy-o",
		    	   			click:function(){
		    	   				this.iframe.contentWindow.saveData(this);
		    	   			}
		    	   		},
		    	   		{
		    	   			caption:"&times;",
		    	   			className:"btn",
		    	   			click:function(){
		    	   				//closeDialog();
		    	   				this.closeDlg();
		    	   			}
		    	   		}]
		    			,window);
	    	}

	    }

	    function  approFun(){
	    	//加载数据

	    	/* http://dyy.jinke.com:8087/ppm/projectTaskInfo/ajax/showProjectTaskInfo?taskId= */
	    	$("#spanAssessment").hide();
       		$.ajax({
       			url:"${contextPath}/ppm/projectTaskInfo/ajax/getByTaskId",
       			data:{taskId:"${param.taskId}"},
       			cache:false,
       			async:false,
       			success:function(res){

       				//已完成，则不显示按钮
       				if(res.data.approvalState==6 || res.data.approvalState==1){
       					$("#boxBottonId").hide();
       				}
       				//不是已完成状态，则显示按钮
       				if(res.data.state!=3){
       					//alert(res.data.state)
       					$("#boxBottonId").show();
       				}
       				taskInfo=res.data;
       				//填充数据
					   fillNodeInfo(res.data);
					   // approvalState为1的时候在审批中 state==6 节点已经完成 retainState==0 节点已移除
					   if(taskInfo.approvalState == 1 || taskInfo.state == 6 || taskInfo.retainState == 0)
					   {
						   $("#btnTaskId").hide();
					   }else{
       						//加载当前节点对应的项目信息
       						loadProjectInfo(res.data.projectId);
					   }
       				//$("#latestStartDateId").text(res.data.latestStartDate.substring(0,10));
       				$("#standardPlanStartDate").attr('title',taskInfo.standardPlanStartDate);
       				$("#standardPlanEndDate").attr('title',taskInfo.standardPlanEndDate);
       				$("#planEndDateId").text(taskInfo.planEndDate.substring(0,10));
       				$("#planStartDateId").text(taskInfo.planStartDate.substring(0,10));


       				if(res.data.state==6){
       					$("#finishDateId").text(res.data.finishDate.substring(0,10));
       					/* 不纳入考核 */
       					if(res.data.assessmentState==2){
							IsAssessment=true;
	       					$("#spanAssessment").show();
							 $("#spanAssessment").attr("title",res.data.assessmentReason);
						}
						 else if(res.data.assessmentState==0){
							IsAssessment=false;
							 $("#spanAssessment").hide();

						}
						else{
							IsAssessment=null;
							$("#spanAssessment").hide();
						   }
						   AssessmentBtn(IsAssessment);
       				}else{
       					$("#finishDateDivID").hide();

       				}
       				approvalState=res.data.approvalState;
       				//alert(res.data.approvalState)
       				/* if(res.data.approvalState==4){
       					$("#backApproveId").show();
       					$("#consentApproveId").show();
       					$("#submitApproveId").hide();
       				} */
       				if(res.data.category=="一级"){
       					$("#taskNameById").css({'font-weight':'bold','font-size':'16px'});
       					transTaskState(res.data.taskState)
       				}else{
       					transTaskState(res.data.taskState)
       					$("#taskNameById").css({'font-size':'16px'});
       				}
       				hideLoading();
       			}
       		});
	    }

	    function transTaskState(taskState){
	    	if(taskState==1){
	    		$("#iCssId").removeClass();
	    		$("#iCssId").css({'color':'#ff9900','font-size':'20px'});
	    		$("#iCssId").addClass("fa  fa-exclamation-circle");
	    	}else if(taskState==2){
	    		$("#iCssId").removeClass()
	    		$("#iCssId").css({'color':'red','font-size':'20px'});;
	    		$("#iCssId").addClass("fa fa-times-circle");
	    	}else if(taskState==3){
	    		$("#iCssId").removeClass();
	    		$("#iCssId").css({'color':'green','font-size':'20px'});
	    		$("#iCssId").addClass("fa fa-check-circle");
	    	}else{
	    		$("#iCssId").removeClass();
	    	}
	    }

	    function addChildenTask(){// 986 497
	    	$.ajax({
       			url:"${contextPath}/ppm/projectTaskInfo/ajax/showProjectTaskInfo",
       			data:{taskId:"${param.taskId}"},
       			cache:false,
       			success:function(res){
       				var subTaskEndTime = new Date(res.data.planEndDate.substring(0,10).replace(/-/g, '/'));
       				 var nowTime=new Date();
       				if(subTaskEndTime>nowTime){
       					var src="${contextPath}/ppm/subTaskInfo/toAddSubTaskInfo?taskId="+${param.taskId};
       					top.showTopDialogs('新增子任务',src,20,700,550
       			    			,[{
       			    	   			caption:"保存",
       			    	   			className:"btn",
       			    	   			icon:"fa fa-floppy-o",
       			    	   			click:function(){
       			    	   				this.iframe.contentWindow.consentTask(this.win);
       			    	   			}
       			    	   		  },
       			    	   		{
       			    	   			caption:"&times;",
       			    	   			className:"btn",
       			    	   			click:function(){
       			    	   				this.closeDlg();
       			    	   			}
       			    	   		}]
       			       ,window);
       				}else{
       					top.bootbox.alert({buttons: {ok:{label: '确定',className:'btn-primary'}},message: '当结束日期小于当前日期时，不能创建子任务！',});
       				}
       			}
       		});
	    }
	     function childenEidt(subTaskId){
	    	var src="${contextPath}/ppm/subTaskInfo/toEditSubTaskInfo?subTaskId="+subTaskId+"&taskId="+${param.taskId};
			top.showTopDialogs('编辑子任务',src,20,700,500,[
			         {
	    	   			caption:"保存",
	    	   			className:"btn",
	    	   			icon:"fa fa-floppy-o",
	    	   			click:function(){
	    	   				this.iframe.contentWindow.eidtChildens(this.win);
	    	   			}
	    	   		  },
	    	   		{
	    	   			caption:"取消",
	    	   			className:"btn",
	    	   			icon:"fa fa-minus-square-o",
	    	   			click:function(){
	    	   				this.closeDlg();
	    	   			}
	    	   		},
	    	   		{
	    	   			caption:"删除",
	    	   			className:"btn",
	    	   			icon:"fa fa-close",
	    	   			click:function(){
	    	   				this.iframe.contentWindow.deleteChildens(this.win);
	    	   			}
	    	   		  }]
	       ,window);
	    }

	    function toGantt(){
	    	//alert(111);
		  //  var src="${contextPath}/ppm/subTaskInfo/toGantt?taskId="+${param.taskId};
	    	//$("#toGanttId").attr('src',src);
	    }
	    function hideGantt(){
	    	if($("#dataTablesubtask_wrapper").is(":hidden")){
	    		$("#dataTablesubtask_wrapper").show();
	    		$("#spanIds").text("隐藏");
	    	}else{
	    		$("#dataTablesubtask_wrapper").hide();
	    		$("#spanIds").text("显示");
	    	}

	    }

	    function reloadResource(){
	    	$("#achieveListBox").html("");
			//加载数据
	   		$.ajax({
	   			url:"${contextPath}/ppm/taskResourceInfo/ajax/loadTaskResourceInfo",
	   			data:{taskId:"${param.taskId}"},
	   			cache:false,
	   			success:function(res){
	   				console.log(res);

	   				//填充文件列表
/* 	   				$("#resourceWorkList").tmpl(res.data).appendTo("#achieveListBox");
	   				var uploadPickers=$("#achieveListBox").find("span.upload"); */
	   				$("#achieveListBox").html("");
	   				$("#resourceOtherTempBox").html("");

   	   				var resourceTempList = new Array();
   	   				var resourceOtherTempList = new Array();

   	   				for(var i=0;i<res.data.length;i++) {
   	   					if (res.data[i].tempFileName != null) {
   	   						resourceTempList.push(res.data[i]);
   	   					} else {
   	   						resourceOtherTempList.push(res.data[i]);
   	   					}
   	   				}


   	   				//填充文件列表
   	   				$("#resourceWorkList").tmpl(resourceTempList).appendTo("#achieveListBox");
   	   				 $("#resourceWorkList").tmpl(resourceOtherTempList).appendTo("#resourceOtherTempBox");
   	   				var uploadPickers = $("#achieveListBox,#resourceOtherTempBox").find("span.upload");

	   				if(taskInfo.state==6 || !(isProjectManager() || isTaskExecutor())){
	   					$("#btnUpload").hide();
	   					$(".mid-line-h").hide();
	   					$(".lisbtn.del").hide();
   						$(".fa-upload,.upload").hide();
	   					//是否是区域经理
	   					if(isRegionalOperationRole==1&&taskInfo.state==6){
	   					   $(".uploadTbdy").show();
		   					$("#btnUpload").show();
		   					$(".mid-line-h").show();
		   					$(".lisbtn.del").show();
	   						$(".fa-upload,.upload").show();
	   					}
	   				//判断是否有值 如果没有则隐藏按钮
	   					if(resourceOtherTempList.length==0){
	   		   	   			 	$("#resourceOtherTempBox").prev().hide();
	   		   	   			    $("#resourceOtherTempBox").next().hide()
	   		   	   		}
	   					if(resourceTempList.length==0){
   		   	   			 	$("#achieveListBox").prev().hide();
   		   	   			    $("#achieveListBox").next().hide()
   		   	   		      }
	   				}
	   				//如果是总部则显示
	   				if(isRegionalOperationRole==3){
	   				 $(".uploadTbdy").show();
	   					$("#btnUpload").show();
	   					$(".mid-line-h").show();
	   					$(".lisbtn.del").show();
   						$(".fa-upload,.upload").show();
	   				}
	   				if (isProjectManager() || isTaskExecutor()){
		   				if (taskInfo.approvalState==1||taskInfo.state==6){
		   					uploadPickers.hide();
	   	   				} else {
			   				uploadPickers.each(function(i,picker){
			   					picker=$(picker);
			   					//console.log(picker);
			   					var pickerId=picker.attr("id");
			   					var formData={resourceId:picker.attr("resourceId"),tempNodeResourceId:picker.attr("tempNodeResourceId")};
			   	   				initUploader(pickerId,function(res){
					   	     		if(res.state==0){
					   	     			var data={taskId:"${param.taskId}",fileName:res.fileName,fileStoragePath:res.path,resourceId:formData.resourceId,tempNodeResourceId:formData.tempNodeResourceId,fileSize:res.fileSize};
					   	     			var url="${contextPath}/ppm/taskResourceInfo/ajax/saveTaskResourceInfo";
					   	     			if (data.resourceId>0){
					   	     				url="${contextPath}/ppm/taskResourceInfo/ajax/updateTaskResource";
					   	     			}
					   	     			$.ajax({
							   	 			url:url,
							   	 			data:data,
							   	 			success:function(res){
							   	 				reloadResource();
							   	 			}
							   	     	});
					   	 	    	}
				   	    		},formData);
			   				});
	   	   				}
	   				}
	   				//总部
	   				//console.log(isRegionalOperationRole+11111111);
	   				if(isRegionalOperationRole==3||(isRegionalOperationRole==1&&taskInfo.state==6)){
	   				    $(".uploadTbdy").show();
	   					$("#btnUpload").show();
	   				    //console.log($("#btnUpload"))
   						uploadPickers.show();
   						uploadPickers.each(function(i,picker){
		   					picker=$(picker);
		   					var pickerId=picker.attr("id");
		   					//console.log(pickerId);
		   					var formData={resourceId:picker.attr("resourceId"),tempNodeResourceId:picker.attr("tempNodeResourceId")};
		   	   				initUploader(pickerId,function(res){
				   	     		if(res.state==0){
				   	     			var data={taskId:"${param.taskId}",fileName:res.fileName,fileStoragePath:res.path,resourceId:formData.resourceId,tempNodeResourceId:formData.tempNodeResourceId,fileSize:res.fileSize};
				   	     			var url="${contextPath}/ppm/taskResourceInfo/ajax/saveTaskResourceInfo";
				   	     			if (data.resourceId>0){
				   	     				url="${contextPath}/ppm/taskResourceInfo/ajax/updateTaskResource";
				   	     			}
				   	     			$.ajax({
						   	 			url:url,
						   	 			data:data,
						   	 			success:function(res){
						   	 				reloadResource();
						   	 			}
						   	     	});
				   	 	    	}
			   	    		},formData);
		   				});
   					}

	   			}
	   		});
		}
	    /**
	      * 初始化页面控件的高度
	      */
	      function initPage(){
	    	  var winHeight=$(window.parent).height();
	    	  var tabHeight=winHeight-$(".task-name-box").outerHeight()-$(".nav-tabs").outerHeight()-30;
	    	  //tab高度
	    	  $(".tab-content").height(tabHeight);
	    	  $("#tab_particulars").height(tabHeight-20);
	    	  $(".tab-pane iframe").height(tabHeight);
	    	  //模板
	    	   $("#tab_model").height(tabHeight-20);
	    	  //留言
	    	   $("#tab_dynamics").height(tabHeight-20)
	    	   //工作成果
	    	   $("#tab_fruits").height(tabHeight-20);
	    	  //日志高度
	    	  $("#tab_log").height(tabHeight-20);
	      }
	    function isTaskToApprove(){
	    	var taskId="${param.taskId}";
	    	$.ajax({
        		url:"${contextPath}/ppm/projectTaskInfo/ajax/findProjectTaskType",
        		data:{taskId:taskId},
	        		success:function(res){
	        			//console.log(res);
	        			if(res.state==0){
	        				$("#btnTaskId").hide();
	        			}
	        		}
        	});
	    }
	  //初始化加载页面数据
        function loadProjectInfo(projectId){
       	//加载项目数据
        	$.ajax({
       			url:"${contextPath}/ppm/projectInfo/ajax/loadProjectInfoDetail",
       			data:{projectId:projectId},
       			cache:false,
       			success:function(res){
       				if (res.state==0){
       					projectData=res.data;
       					//项目经理或者执行人，显示节点的操作按钮，项目经理才能添加子任务
       					if (isProjectManager()){
       						$("#completedTask,#addChildenTask,#removeGuide,#changeGuide").show();
       					} else if (isTaskExecutor()){
       						$("#completedTask,#removeGuide,#changeGuide").show();
       					}
       				}
       			}
       		});
        }
	      //判断当前是否是项目经理或执行人
	      function isProjectManager(){
	    	  var currUserId = "${sessionScope.loginStaff.staffId}";
	    	  if (currUserId==projectData.projectManager){
	    		  return true;
	    	  }
	    	  return false;
	      }
	      function isTaskExecutor(){
	    	  var currUserId = "${sessionScope.loginStaff.staffId}";
	    	  if (currUserId==taskInfo.executor){
	    		  return true;
	    	  }
	    	  return false;
	      }
	      //删除节点文件
	      function deleteTaskResource(resourceId) {
	       	   top.bootbox.confirm({
	      	        buttons: {
	      	            confirm: {
	      	                label: '确定',
	      	                className: 'btn-primary'
	      	            },
	      	            cancel: {
	      	                label: '取消',
	      	                className: 'btn-default'
	      	            }
	      	        },
	      	        message: '您确定删除此附件？',
	      	        callback: function(result) {
	      	            if(result) {
	      	            	$.ajax({
	      	      	   			url:"${contextPath}/ppm/taskResourceInfo/deleteTaskResource",
	      	      	   			data:{resourceId:resourceId},
	      	      	   			type:"post",
	      	      	   			cache:false,
	 	     	   	   			success:function(res){
	 	     	   	   				//console.log(res);
	 	     	   	   				reloadResource();
	 	     	   	   			}
	      	      			});
	      	            }
	 				}
	    	   		});
	    		}
    </script>
    <!-- listTaskExperienceInfo -->
    <script type="text/javascript">
   	function reloadData(){
   		$("#dataTable").DataTable().ajax.reload();
   	}
   	$(document).ready(function(){
   		$("#btnSearch").on("click",function(){
   			reloadData();
   		});
   		var tablesSubtask = $("#dataTablesubtask").dataTable({
   		        serverSide: true,//分页，取数据等等的都放到服务端去
   		        lengthMenu:false,
   		        pageLength: 50,  //首次加载的数据条数
   		        lengthChange:false,
   		        pagingType: "simple_numbers",
   		        autoWidth: false,
   		        stateSave: false,
   		        searching: false,//禁用datatables搜索,
   		        sort: false,
   		        ajax: {
   		            url:"${contextPath}/ppm/subTaskInfo/ajax/listSubTaskInfo",
   		            dataSrc: "data",
   		            cache:false,
   		            type:"GET",
   		            data:function (d) {
   		                   var param = {};
   		                   param.draw = d.draw;
   		                   param.start = d.start;
   		                   param.length =d.length;
   		                   param["taskId"]="${param.taskId}";
   		                   return param;//自定义需要传递的参数。
   		            },
   	                error:function(){
   	                	if (arguments[0].status==500){
   	                		top.bootbox.alert("系统忙，请稍候再试！");
   	                	}
   	                	else if(arguments[1]=="parsererror"){
   	                		top.bootbox.alert({buttons: {ok:{label: '确定',className:'btn-primary'}},message: '登录已失效，请重新登录！',
   	        					callback : function() {
   	        						top.location.reload();
   	        					}
   	        				});
   	                	}
   	                }
   		        },
   		        columns: [//对应上面thead里面的序列
   			              {"data": 'subTaskId',"render":function(data, type, row, meta){
   			            	var  classStr;
   			              if(row.taskState==0){
   			            	classStr = "fa fa-check-square ";
   			              }else{
   			            	classStr = "fa fa-check-square isOver";
   			              }
   			               var srctr="<a href='javascript:void(0)' onclick='completeChilden("+row.subTaskId+","+row.taskState+")'> "+'<i class="'+classStr+'" style="font-size:20px;" data="184"></i>'+"</a>";
   			               return srctr;
     						}},
   			              {"data": 'title' ,"render":function(data, type, row, meta){
     			                var srctr="<a href='javascript:void(0)' onclick='childenEidt("+row.subTaskId+","+row.taskState+")'> "+data+"</a>";
     			                return srctr;
       						}},
   			              {"data": 'cname' },

   			              {"data": 'subTaskEnd',"render":function(data, type, row, meta){

 			                return data.substring(0,10);
   						  }},
   		        ],
   		        //操作按钮
   		        columnDefs: [
   					{
   					}

   		        ],
   		        language: {
   		            lengthMenu: "每页显示_MENU_行",
   		            processing: "正在加载数据...",
   		            paginate: {
   		                previous: "上页",
   		                next: "后页"
   		            },
   		            zeroRecords: "没有数据",
   		            info: "当前 _START_ 至 _END_ 行 &nbsp;&nbsp;共 _PAGES_ 页",
   		            infoEmpty: "",
   		            infoFiltered: "",
   		            sSearch: "输入关键字：",
   		        },
   		        //在每次table被draw完后回调函数
   		        fnDrawCallback: function(row, data, dataIndex ){
   		        	$("#dataTablesubtask_paginate").parent().css({"display":"none"});
   		        	$("#dataTablesubtask_info").parent().css({"display":"none"});
   		          //dataTableScrollBar($('.dataTablesubtask_scrollBody'),"CMY_dataTables_scrollBody_scroll2");
   		            hideLoading();
   		        }
   		   });
   		completeChilden =	function(subTaskId,state){
   			if(!isProjectManager||state==0){
   				return false;
   			}
			top.bootbox.confirm({
      	        buttons: {
      	            confirm: {
      	                label: '确定',
      	                className: 'btn-primary'
      	            },
      	            cancel: {
      	                label: '取消',
      	                className: 'btn-default'
      	            }
      	        },
      	        message: '确定完成子任务吗？',
      	        callback: function(result) {
      	            if(result) {
      	            	var data={"subTaskId":subTaskId};
      	  				$.ajax({
      	         			url:"${contextPath}/ppm/subTaskInfo/ajax/updateTaskState",
      	         			data:data,
      	         			cache:false,
      	         			success:function(res){
      	         				if(res.state==0){
      	         					window.location.reload()
      	         				}
      	         			}
      	         		});
      	            }else{

      	            }
 				}
    	   	});
		}
		 function childenEidt(subTaskId,taskState){
		    	var src="${contextPath}/ppm/subTaskInfo/toEditSubTaskInfo?subTaskId="+subTaskId+"&taskId="+${param.taskId};
		    	var srcView="${contextPath}/ppm/subTaskInfo/toViewSubTaskInfo?subTaskId="+subTaskId+"&taskId="+${param.taskId};
		    	var btns=[];
		    	if (taskState==0){
		    		btns=[
		    		      <h:tag id="btnCompleteSubTask">
		    		      {
	    	   			caption:"完成",
	    	   			className:"btn",
	    	   			icon:"fa fa-flag",
	    	   			click:function(){
	    	   				this.iframe.contentWindow.completeChilden(this.win);
	    	   			}
	    	   		  }
		    		      ,
		    		      </h:tag>
		    		      <h:tag id="btnSave">
		    		      {
		    	   			caption:"保存",
		    	   			className:"btn",
		    	   			icon:"fa fa-floppy-o",
		    	   			click:function(){
		    	   				this.iframe.contentWindow.eidtChildens(this.win);
		    	   			}
		    	   	}
		    		      ,
		    		      </h:tag>
		    		      <h:tag id="btnDelete">
		    		      {
	    	   			caption:"删除",
	    	   			className:"btn",
	    	   			icon:"fa fa-close",
	    	   			click:function(){
	    	   				this.iframe.contentWindow.deleteChildens(this.win);
	    	   			}
	    	   		}
		    		      ,
		    		      </h:tag>
		    		      {
	    	   			caption:"&times;",
	    	   			className:"btn",
	    	   			//icon:"fa fa-minus-square-o",
	    	   			click:function(){
	    	   				this.closeDlg();
	    	   			}
	    	   		}];
		    		top.showTopDialogs('编辑子任务',src,20,700,500
			    			,btns
			       ,window);
		    	} else {
		    		btns=[{
	    	   			caption:"取消",
	    	   			className:"btn",
	    	   			icon:"fa fa-minus-square-o",
	    	   			click:function(){
	    	   				this.closeDlg();
	    	   			}
	    	   		}];
		    		top.showTopDialogs('查看子任务',srcView,20,700,500
			    			,btns
			       ,window);
		    	}
		    }
	   	var tables = $("#dataTable").dataTable({
	    	"scrollX": true,
	    	"scrollY": "300px",
	        serverSide: true,//分页，取数据等等的都放到服务端去
	        //processing: true,//载入数据的时候是否显示“载入中”
	        lengthMenu:[5,10,20,30,40,50],
	        pageLength: 10,  //首次加载的数据条数
	        lengthChange:true,
	        //ordering: true, //排序操作在服务端进行，所以可以关了。
	        pagingType: "simple_numbers",
	        autoWidth: false,
	        stateSave: false,//保持翻页状态，和comTable.fnDraw(false);结合使用
	        searching: false,//禁用datatables搜索,
	        sort: false,
	        //sorting: [0, "desc"],
	        ajax: {
	            url:"${contextPath}/ppm/taskExperienceInfo/ajax/loadTaskExperienceInfoForTable",
	            dataSrc: "data",
	            cache:false,
	            data: function (d) {
	                   var param = {};
	                   param.draw = d.draw;
	                   param.start = d.start;
	                   param.length =d.length;
	                   var keyword=$("#keyword").val();
	                   param["taskId"]="${param.taskId}";
	                   param["keyword"]=keyword;
	                   return param;//自定义需要传递的参数。
	            },
                error:function(){
                	if (arguments[0].status==500){
                		top.bootbox.alert("系统忙，请稍候再试！");
                	}
                	else if(arguments[1]=="parsererror"){
                		top.bootbox.alert({buttons: {ok:{label: '确定',className:'btn-primary'}},message: '登录已失效，请重新登录！',
        					callback : function() {
        						top.location.reload();
        					}
        				});
                	}
                }
	        },
	        columns: [//对应上面thead里面的序列
	        	      {"data": 'projectId',"class":"text-center","render": function(data, type, row, meta) {
	        	      if(row.sort==1){
	        	    	  return "<img src='${contextPath}/static/images/icon/panel_top.png'/>";
	        	      }else{
	        	    	  return " ";
	        	      }
	        	      }},
		              {"data": 'projectName',"class":"text-left"},
		              {"data": 'jurisdictionArea',"class":"text-center" },

	        	      {"data": 'projectManagerCname',"class":"text-center","render": function(data, type, row, meta) {
	        	    	  //console.log(row);
		            	  return "<span class='projectManagerAlert' data='"+row.projectManager+"' >"+row.projectManagerCname+"</span>";
	        	      }  },
	        	      {"data": 'content',"class":"text-left","render": function(data, type, row, meta) {
	        	    	  //console.log(row);
	        	    	  	var strcontent="";
	        	    	  	if(row.content.length>=10){
	        	    	  		strcontent= row.content.substring(0,9)+"...";
	        	    	  	}else{
	        	    	  		strcontent=row.content;
	        	    	  	}
		            	  	return "<span class='content' data='"+row.content+"' title='"+row.content+"'>"+strcontent+"</span>";
	        	      }  },
	        ],
	        //操作按钮
	        columnDefs: [
				{
				}

	        ],
	        language: {
	            lengthMenu: "每页显示_MENU_行",
	            processing: "正在加载数据...",
	            paginate: {
	                previous: "上页",
	                next: "后页"
	            },
	            zeroRecords: "没有数据",
	            info: "当前 _START_ 至 _END_ 行 &nbsp;&nbsp;共 _PAGES_ 页",
	            infoEmpty: "",
	            infoFiltered: "",
	            sSearch: "输入关键字：",
	        },
	        //在每次table被draw完后回调函数
	        fnDrawCallback: function(row, data, dataIndex ){
	        	$("#dataTable_length").css({"display":"inline"});
	        	$("#dataTable_info").css({"display":"inline"});
            	$("#dataTable_info").append("&nbsp;&nbsp;&nbsp");
            	$("#dataTable_info").after($("#dataTable_length"));
            	$("#dataTable_info").parent().css({"white-space":"nowrap"});
            	$("#dataTable").width("100%");
               	//by CMY 滚动条
               $('.dataTables_scrollBody').css('overflow','hidden');
            	if($('.dataTables_scrollBody').attr('id')=='CMY_dataTables_scrollBody_scroll'){
              		CMY_dataTables_scroll.setSize();
              	}else{
              		$('.dataTables_scrollBody').attr('id','CMY_dataTables_scrollBody_scroll');
              		$('.dataTables_scrollBody').css('overflow','hidden');
              		 CMY_dataTables_scroll = new MyScrollBar({
              			selId: 'CMY_dataTables_scrollBody_scroll',
              			hasX: false,
              			hasY: true,
              			width: 4
              		});
              	}
	            hideLoading();
	            var index1=0;
	            $("#dataTable").find("tr").each(function(){
	            	var tdArr = $(this).children();
	            	tdArr.eq(0).on( 'click', function () {
	            		onclickExperienceInfo($(this).parent());
	        	    });
	            	tdArr.eq(1).on( 'click', function () {
	            		onclickExperienceInfo($(this).parent());
	        	    });
	            	tdArr.eq(2).on( 'click', function () {
	            		onclickExperienceInfo($(this).parent());
	        	    });
	            	tdArr.eq(3).attr("align","center");
	            	tdArr.eq(4).on( 'click', function () {
	            		onclickExperienceInfo($(this).parent());
	        	    });
	            	//onclickExperienceInfo(this);
	                //index1++;
	           		//alert(index1);

	            });

	        },
	        fnInitComplete:function(){
	        	 dataTableScrollBar($("#tab_particulars"));
	        }
	   });
	   	//给项目经理绑定一个弹窗

		$(document).on("click",".projectManagerAlert",function(e){
   						var staffId=$(this).attr("data");
   					    showStaff(this,staffId);
   					    e.stopPropagation();
   					    e.preventDefault();
   					    return false;
   					})
   		$(document).on("mouseleave",".t2m-filter-box",function(){
   					//	$(this).remove();
   					})
   		function showStaff(src,staffId){
        	if (!staffId){
        		return;
        	}
        	$.ajax({
        		url:"${contextPath}/company/staffInfo/ajax/loadStaffInfo",
        		data:{staffId:staffId},
        		cache:false,
        		success:function(res){
        			if (res.state==0){
        				res.data.dname=res.data.deptList[0].deptName;
        				showTip(src,staffId,function(c,data){
        					if (res.data.email) {
            					res.data.email=res.data.email.replace(/null|\(null\)/gi,"");
            				}
        					//console.log(res.data)
	        				$("#staffInfoTmpl").tmpl(res.data).appendTo(this.dlg);
        				})

        			}
        		}
        	});
        }
		function onclickExperienceInfo(obj){
	   		var data=tables.api().row( obj ).data();
	    	var sortSetUp=0;
			var sortName='';
			if(data.sort=="1"){
				sortName='取消置顶';
				sortSetUp="0";
			}else{
				sortName='置顶';
				sortSetUp="1";
			}
	    	var expId=data.experienceId;
	    	var src="${contextPath}/ppm/taskExperienceInfo/showTaskExperienceInfo?experienceId="+expId;//+"&achieveStandard="+achieveStandard;
		    top.showTopDialogs('经验详情',src,20,700,550,[
		    	<h:tag id="ExperienceSetTopTask">
		    	{
		    	    caption:sortName,
		    	    className:"btn",
		    	    icon:"icon icon-panel_top",
		    	    click:function(){
		    	        var thisdata = this;
		    	        $.ajax({
		    	            url:"${contextPath}/ppm/taskExperienceInfo/ajax/updateSort",
		    	            data:{experienceId:expId,sort:sortSetUp},
		    	            cache:false,
		    	            success:function(res){
		    	                thisdata.closeDlg();
		    	                reloadData();
		    	            },
		    	            error:function(){
		    	                thisdata.closeDlg();
		    	                reloadData();
		    	            }
		    	        });
		    	    }
		    	},
			    </h:tag>
		    	{
	   				caption:"&times;",
		   			className:"btn",
		   			click:function(){
		   				this.closeDlg();
		   				reloadData();
		   			}
	   			}
		   ],window);
	    };


		/* $("#dataTable > tbody tr").each(function(){
   		index1++;
   		alert(index1);
		}); */
	   /* 留言反馈 */
	   $(".new_notice_feddbackMessage").on("click",function(){
			$("#feddbackMessage_box").show();
		})
		$("#feddbackMessage_close").on("click",function(){
			$("#feddbackMessage_box").hide();

		})
		$(".show_tab").on("click",function(){
			$("#at_Message_box .con_tab>div").hide();
			$(".show_tab").removeClass("active");
			$($(this).addClass("active").attr("data-action")).show();
		})
		$("#at_Message_box_close").on("click",function(){
			$("#at_Message_box").hide();
		})
		$("#searchMessageBoxBtn").on("click",function(){
			showName_tab_lis($("#searchMessageBoxTxt").val())
		})
		/* 显示艾特@ */
		$(".new_notice_alt").on("click",function(){
			$("#at_Message_box").show().attr("data-action",$(this).attr("data-action"));

		})
		/* 全選 */
		$(".name_tab_lis_all").on("click",function(){
			if($(this).is(':checked')){
				$(this).parent().parent().find(".lis_tab").removeClass("active").addClass("active");
				$(this).parent().parent().find(".lis_tab").each(function(){
					var divid=$("#at_Message_box").attr("data-action");
					var id = $(this).attr("data-id");
					var name =$(this).attr("data-name");
					if(!$(""+divid+" .messageAptdel[data-id='"+id+"']").length>0){
						atToDiv(name,id,divid);
					}
				})
			}else{
				$(this).parent().parent().find(".lis_tab").addClass("active").removeClass("active");
				$(this).parent().parent().find(".lis_tab").each(function(){
					var divid=$("#at_Message_box").attr("data-action");
					var id = $(this).attr("data-id");
					//console.log($(this));
					$(""+divid+" .messageAptdel[data-id='"+id+"']").parent().remove();


				})
			}
		})
		/* 人員選中 */
	    $(document).on("click",".name_tab_lis .lis_tab",function(){
			var divid=$("#at_Message_box").attr("data-action");
			var id = $(this).attr("data-id");
			var name =$(this).attr("data-name");
			/* 判断是否重复选中 */
	    	if($(this).hasClass("active")){
				$(this).removeClass("active");
				$(""+divid+" .messageAptdel[data-id='"+id+"']").parent().remove();
			}else{
				$(this).addClass("active");
				if(!$(""+divid+" .messageAptdel[data-id='"+id+"']").length>0){
					atToDiv(name,id,divid);
				}
			}
		})
		$(document).on("click",".messageAptdel",function(){
		    $(this).parent().remove()
		})
		allRemindingStaffId =  function (id){
			  var str="";

			  $(id).find(".messageAptdel").each(function(){
				  var ttr = $(this).attr("data-id")+",";
				 str += ttr;
			  });

			  return   str.substring(0,str.length-1);


		  }
		/* 添加到什么地方 */
		function atToDiv(name,id,divid){
		   var str = '<span>@'+name+' <i class="fa fa-fw fa-close messageAptdel" data-id="'+id+'"></i></span>';
		   $(str).appendTo(""+divid);
	   }
		function showDeptData(DeptId){
			$.ajax({
				url:"${contextPath}/company/staffInfo/findUserNamesStaffDepRef",
				data:{'deptId':DeptId},
				type:"POST",
				success:function(res){
					//console.log(res);
					$("#name_tab_lis_all2").removeAttr("checked")
					$("#p_con_lis .lis_tab").remove();
					$("#tmp_lis_tab2").tmpl(res).appendTo("#p_con_lis");
				}
			});

	   }
		function showName_tab_lis(cname){
			$.ajax({
				url:"${contextPath}/company/staffInfo/ajax/loadStaffInfoListMap",
				data:{'cname':cname||null},
				success:function(res){

					console.log(res);
					//console.log(res);
					$("#name_tab_lis_all").removeAttr("checked")
					$("#name_tab_lis .lis_tab ").remove();
					$("#tmp_lis_tab").tmpl(res.data).appendTo("#name_tab_lis");
				}
			});

	   }
	   // zTree 的参数配置，深入使用请参考 API 文档（setting 配置详解）
	   var setting = {
			   async: {
					enable: true,
					url: "${contextPath}/company/deptInfo/ajax/listDeptInfoForZtree",
					autoParam: ["id"],
					dataFilter:function(treeId, parentNode, responseData){
						//$("#ZtbSuch").parent().show();
						return responseData;
					}
				},
				callback: {
					onClick: function(event, treeId, treeNode){
						//console.log(treeNode);
						showDeptData(treeNode.id);
						/* showDetail(treeNode.id);
						currSelectedDeptId=treeNode.id; */
					}
				}

	};
	      zTreeObj = $.fn.zTree.init($("#Ztb"), setting);
	      zTreeStatInit =   function (zTreeObj){
	    	  //zTreeObj.checkAllNodes(false);
	    	  //zTreeObj.cancelSelectedNode();
		  }
	      altStatInit = function (){
			$("#searchMessageBoxTxt").val("");
			$(".name_tab_lis .lis_tab").remove();
			zTreeStatInit(zTreeObj)
		};
		  //取消反馈
		  $("#feddbackExit").on("click",function(){
			  $("#feddbackMessage_box").hide();
			  $("#feddbackMessageTxt").val("");
			  $("#messagefeddback").html("");
		  })
		  $("#savefeddback").on("click",function(){
			  var taskId = "${param.taskId}";
			  var content =  $("#feddbackMessageTxt").val();
			  var remindingStaffId = allRemindingStaffId("#messagefeddback");
			  content = content.replace(/\r{0,}\n/g,"<br/>").replace(/\s/g,"&nbsp;");
			  $.ajax({
				  url:"${contextPath}/sys/messageInfo/saveFeddbackMessage",
				  data:{"taskId":taskId,"content":content,"remindingStaffId":remindingStaffId},
				  type:"post",
				  success:function(res){
					  if (res.state == 0) {
						  $("#messagefeddback").html("");


						  top.bootbox.alert({buttons: {ok:{label: '关闭',className:'btn-primary'}},message: '反馈成功！'});

						  $("#feddbackMessage_box").hide();
						  $("#feddbackMessageTxt").val("");
						  altStatInit();
					  } else {
						  top.bootbox.alert({buttons: {ok:{label: '关闭',className:'btn-primary'}},message: '反馈失败！'});
					  }
				  }
			  });

		  })
   })
   $(function(){
	 dataTableScrollBar($("#tab_particulars"));
	 $(".nav-tabs-custom > .nav-tabs > li > a").on("click",function(){
		 $("#tab_particulars").hide();
		 $("#tab_dynamics").hide();
		 $("#tab_model").hide();
		 $("#tab_fruits").hide();
		 $("#tab_log").hide();

		 var id =$(this).attr("href");
		 $(id).show();
	     if(id=="#tab_particulars"){
	    	 dataTableScrollBar($("#tab_particulars"));
	     }
	     if(id=="#tab_dynamics"){
	    	 dataTableScrollBar($("#tab_dynamics"));
	    	   if($("#tab_dynamics>div:first-child").attr("id")=="tab_dynamicsSlBar"){
		        	 dataTableScrollBar($("#tab_dynamics"),"","",true);
		             return ;
		           }
	     }
	     if(id=="#tab_fruits"){
	    	 dataTableScrollBar($("#tab_fruits"));
	     }
	     if(id=="#tab_model"){
	    	 dataTableScrollBar($("#tab_model"));
	    	 if($("#tab_dynamics>div:first-child").attr("id")=="tab_model_slbar"){
	        	 dataTableScrollBar($("#tab_model"),"","",true);
	             return ;
	           }

	     }
	     if(id=="#tab_log"){
	          dataTableScrollBar($("#tab_log"));
	           if($("#tab_log>div:first-child").attr("id")=="logListBox"){
	        	 dataTableScrollBar($("#tab_log"),"","",true);
	             return ;
	           }

	     }
		 //dataTableScrollBar($(".tab-pane"))
	 })

   })

    </script>
</body>
</html>
